#!/usr/bin/sh

source `dirname "$0"`/scripts/colors.sh

# --- Functions
function get_date {
    echo `date` | sed -e 's/:[0-9][0-9] .*//'
}

function get_volume {
    amixer sget Master | tail -n1 | sed "s/.*\[\(.*\)\%\].*/\1/"
}

function get_battery_charge_avg {
    local BAT1=`acpi | head -n1 | sed "s/.* \([0-9].*\)%.*/\1/"`
    local BAT2=`acpi | tail -n1 | sed "s/.* \([0-9].*\)%.*/\1/"`
    local BATAVG=`echo "scale=1; (0.7*$BAT1)+(0.3*$BAT2)" | bc -l`
    local BATLESS=`echo $BAT1'>20' | bc -l`
    if [ $BATLESS -eq 1 ]; then
	echo $BATAVG
    else
	echo "^fg($BatteryLow)" $BATAVG "^fg()"
    fi
}

# --- Format the output
function output {
    while :;
    do
	echo "^p(_LEFT) ^p(;+2)" "^fg($InfoLabel)vol^fg()" `get_volume` "^ca(1, `dirname "$0"`/scripts/panels/battery_panel.sh)^fg($InfoLabel)bat^fg()" `get_battery_charge_avg` "^ca()^p(_CENTER)^p(-80)" `get_date`;
	sleep 1;
    done
}

# --- Pipe output to dzen
output | dzen2 -fn "Avenir LT Std:size=13:antialias=true" -p -y -30 -dock -h 30 -ta l -u -bg \#777766 -fg \#FFFFFF
